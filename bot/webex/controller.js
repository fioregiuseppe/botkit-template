module.exports = function() {
    // Load environment variables from project .env file
    require('node-env-file')(__dirname + '/.env');


    // Fetch token from environement
    // [COMPAT] supports SPARK_TOKEN for backward compatibility
    var accessToken = process.env.ACCESS_TOKEN || process.env.SPARK_TOKEN
    if (!accessToken) {
        console.log("Could not start as this bot requires a Webex Teams API access token.");
        console.log("Please invoke with an ACCESS_TOKEN environment variable");
        console.log("Example:");
        console.log("> ACCESS_TOKEN=XXXXXXXXXXXX PUBLIC_URL=YYYYYYYYYYYYY node bot.js");
        process.exit(1);
    }

    // Get public URL where the Webex cloud platform will post notifications (webhook registration)
    var public_url = process.env.PUBLIC_URL;
    // Infer the app domain for popular Cloud PaaS
    if (!public_url) {

        // Heroku hosting: available if dyno metadata are enabled, https://devcenter.heroku.com/articles/dyno-metadata
        if (process.env.HEROKU_APP_NAME) {
            public_url = "https://" + process.env.HEROKU_APP_NAME + ".herokuapp.com";
        }

        // Glitch hosting
        if (process.env.PROJECT_DOMAIN) {
            public_url = "https://" + process.env.PROJECT_DOMAIN + ".glitch.me";
        }
    }
    if (!public_url) {
        console.log("Could not start as this bot must expose a public endpoint.");
        console.log("Please add env variable PUBLIC_URL on the command line or to the .env file");
        console.log("Example: ");
        console.log("> ACCESS_TOKEN=XXXXXXXXXXXX PUBLIC_URL=YYYYYYYYYYYYY node bot.js");
        process.exit(1);
    }

    var Botkit = require('botkit');


    // Create the Botkit controller, which controls all instances of the bot.
    var env = process.env.NODE_ENV || "development";
    var controller = Botkit.sparkbot({
        log: true,
        public_address: public_url,
        ciscospark_access_token: accessToken,
        secret: process.env.SECRET, // this is a RECOMMENDED security setting that checks if incoming payloads originate from Webex
        webhook_name: process.env.WEBHOOK_NAME || ('built with BotKit (' + env + ')')
    });

    return controller;
}